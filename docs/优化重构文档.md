# 短信监控应用优化重构文档

## 项目概述
当前系统是一个短信监控应用，能够拦截包含特定关键词的短信，并将其上报到指定服务器。目前系统已经具备基本的短信监控、过滤和上报功能，但需要进行优化和功能扩展。

## 优化目标
1. 保持代码简洁，易于理解
2. 不引入新的框架和库
3. 添加新功能：API配置、推送到钉钉群、扩展到其他社交软件、推送记录展示和管理

## 优化步骤

### 1. API配置功能 ✅
- 修改 `AppConfig` 类，添加API配置相关功能
  - 添加API配置界面，允许用户设置API服务器地址
  - 增加API链接测试功能
  - 存储配置到 SharedPreferences
- 实现内容:
  - 在MainActivity中添加API配置界面元素
  - 在AppConfig中支持API URL的读写操作
  - 添加API测试功能确保连接有效

### 2. 推送到钉钉群 ✅
- 添加钉钉群机器人配置
  - 实现钉钉Webhook URL配置
  - 实现钉钉推送消息格式设置
- 实现钉钉推送功能
  - 添加 `DingTalkService` 类处理钉钉推送
  - 在短信处理流程中加入钉钉推送逻辑
- 实现内容:
  - 在UI中添加钉钉配置选项
  - 实现钉钉消息格式化功能
  - 开发钉钉webhook推送功能
  - 添加钉钉推送开关设置

### 3. 推送到其他社交软件的扩展能力 ✅
- 设计通用推送接口
  - 创建 `PushService` 接口
  - 实现基本的推送方法
- 实现针对不同平台的推送服务
  - 创建 `DingTalkPushService` 实现钉钉推送
  - 预留其他推送服务的扩展点 (如微信、Telegram等)
- 实现推送服务管理器
  - 添加 `PushServiceManager` 管理不同推送服务
  - 实现推送服务的动态加载和配置
- 实现内容:
  - 开发通用推送接口和抽象类
  - 实现钉钉推送的具体实现类
  - 实现推送服务管理器
  - 提供用户界面用于配置不同的推送服务

### 4. 短信内容过滤优化 ✅
- 统一短信过滤实现
  - 统一使用 `SMSFilter` 类处理短信过滤逻辑
  - 移除重复的过滤实现
- 简化过滤逻辑
  - 保持短信内容原样，不做任何加工处理
  - 直接使用原始内容进行关键字匹配
- 优化代码结构
  - 删除废弃的API
  - 清理不再使用的方法
- 实现内容:
  - 优化 `SMSFilter.matchesFilter` 方法
  - 移除内容标准化处理
  - 删除 `SettingsService.containsKeyword` 方法
  - 统一短信处理服务中的过滤逻辑

### 5. 推送记录的展示和相关按钮功能 ⬜
- 设计推送记录界面
  - 使用 Compose 实现记录列表显示
  - 添加筛选和排序功能
- 实现推送记录数据存储和获取
  - 扩展数据库以保存推送记录
  - 实现记录查询功能
- 添加记录管理功能
  - 实现记录查看、删除功能
  - 添加手动重新推送功能
  - 添加推送失败重试功能
- 实现内容:
  - 设计和实现推送记录展示界面
  - 开发推送记录的数据库操作功能
  - 实现记录管理相关功能按钮
  - 添加推送状态显示和管理功能

## 实施计划

### 阶段一: 基础API配置功能 ✅
- 完成API配置UI界面
- 实现API配置存储和读取功能
- 添加API连接测试功能

### 阶段二: 钉钉群推送功能 ✅
- 实现钉钉Webhook配置界面
- 开发钉钉消息推送功能
- 集成到现有短信处理流程

### 阶段三: 推送扩展框架 ✅
- 设计并实现通用推送接口
- 将钉钉推送重构为扩展接口的实现
- 实现推送服务管理器

### 阶段四: 短信过滤优化 ✅
- 统一短信过滤实现方式
- 简化过滤逻辑，保持短信内容原样
- 清理冗余代码

### 阶段五: 推送记录功能 ⬜
- 设计推送记录数据库结构
- 实现推送记录UI界面
- 开发记录管理相关功能

## 技术细节

### API配置实现要点
- 在 `AppConfig` 中添加API URL配置项的存储和读取
- 在MainActivity中添加API配置界面元素
- 实现API连接测试功能

### 钉钉推送实现要点
- 创建钉钉推送服务类实现webhook请求
- 设计钉钉消息格式和配置项
- 添加安全签名支持

### 通用推送框架实现要点
- 设计 `PushService` 接口定义基本推送方法
- 实现抽象推送服务类处理通用逻辑
- 开发推送服务注册和管理机制

### 短信过滤优化要点
- 统一使用 `SMSFilter` 进行短信过滤
- 移除内容标准化处理，保留短信原始内容
- 优化关键字匹配算法，提高匹配效率
- 删除冗余和弃用的过滤相关API

### 推送记录实现要点
- 扩展数据库添加推送记录表
- 设计推送记录Compose UI组件
- 实现推送记录的CRUD操作

## 状态标记说明
- ⬜ 未完成
- ✅ 已完成 