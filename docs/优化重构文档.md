# 短信监控应用优化重构文档

## 项目概述
当前系统是一个短信监控应用，能够拦截包含特定关键词的短信，并将其上报到指定服务器。目前系统已经具备基本的短信监控、过滤和上报功能，但需要进行优化和功能扩展。

## 优化目标
1. 保持代码简洁，易于理解
2. 不引入新的框架和库
3. 添加新功能：API配置、推送到钉钉群、扩展到其他社交软件、推送记录展示和管理

## 优化步骤

### 1. API配置功能 ✅
- 修改 `AppConfig` 类，添加API配置相关功能
  - 添加API配置界面，允许用户设置API服务器地址
  - 增加API链接测试功能
  - 存储配置到 SharedPreferences
- 实现内容:
  - 在MainActivity中添加API配置界面元素
  - 在AppConfig中支持API URL的读写操作
  - 添加API测试功能确保连接有效

### 2. 推送到钉钉群 ✅
- 添加钉钉群机器人配置
  - 实现钉钉Webhook URL配置
  - 实现钉钉推送消息格式设置
- 实现钉钉推送功能
  - 添加 `DingTalkService` 类处理钉钉推送
  - 在短信处理流程中加入钉钉推送逻辑
- 实现内容:
  - 在UI中添加钉钉配置选项
  - 实现钉钉消息格式化功能
  - 开发钉钉webhook推送功能
  - 添加钉钉推送开关设置

### 3. 推送到其他社交软件的扩展能力 ✅
- 设计通用推送接口
  - 创建 `PushService` 接口
  - 实现基本的推送方法
- 实现针对不同平台的推送服务
  - 创建 `DingTalkPushService` 实现钉钉推送
  - 预留其他推送服务的扩展点 (如微信、Telegram等)
- 实现推送服务管理器
  - 添加 `PushServiceManager` 管理不同推送服务
  - 实现推送服务的动态加载和配置
- 实现内容:
  - 开发通用推送接口和抽象类
  - 实现钉钉推送的具体实现类
  - 实现推送服务管理器
  - 提供用户界面用于配置不同的推送服务

### 4. 短信内容过滤优化 ✅
- 统一短信过滤实现
  - 统一使用 `SMSFilter` 类处理短信过滤逻辑
  - 移除重复的过滤实现
- 简化过滤逻辑
  - 保持短信内容原样，不做任何加工处理
  - 直接使用原始内容进行关键字匹配
- 优化代码结构
  - 删除废弃的API
  - 清理不再使用的方法
- 实现内容:
  - 优化 `SMSFilter.matchesFilter` 方法
  - 移除内容标准化处理
  - 删除 `SettingsService.containsKeyword` 方法
  - 统一短信处理服务中的过滤逻辑

### 5. 界面布局优化 ✅
- 结构优化
  - 使用Tab布局组织不同功能区域
  - 添加顶部导航栏，清晰显示当前功能区
  - 使用卡片分组相关功能，提高视觉层次感
- 服务配置界面统一
  - 创建通用的服务配置组件，支持各类推送服务
  - 减少配置界面重复代码
  - 添加服务状态指示器
- 视觉设计优化
  - 统一按钮、开关、输入框等控件样式
  - 优化元素间距和对齐方式
  - 添加图标和视觉提示，提高可识别性
- 交互体验优化
  - 添加下拉刷新、滑动删除等交互功能
  - 改进异步操作的进度指示
  - 优化错误提示显示方式
- 实现内容:
  - 设计Tab布局基础框架
  - 重构现有功能到对应标签页
  - 开发通用的服务配置组件
  - 实现界面主题和样式统一

### 6. 推送记录的展示和相关按钮功能 ✅
- 设计推送记录界面
  - 使用 Compose 实现记录列表显示
  - 添加标签页分类不同状态的记录
- 实现推送记录数据存储和获取
  - 扩展数据库以保存推送记录
  - 实现记录查询和状态更新功能
- 添加记录管理功能
  - 实现记录查看、状态管理功能
  - 添加失败记录重试功能按钮
  - 实现最大重试次数限制
- 强化推送记录信息展示
  - 显示关联的短信内容和发件人
  - 提供短信内容的展开/折叠功能
  - 添加复制短信内容到剪贴板功能
  - 显示错误信息以便故障排查
- 实现内容:
  - 设计和实现推送记录展示界面，使用 Tab 分类展示全部记录和失败记录
  - 开发推送记录的数据库操作功能，包括查询、状态更新
  - 实现记录状态视觉反馈，使用不同颜色区分成功、失败和待处理状态
  - 添加失败记录的重试功能按钮，并显示重试次数
  - 异步加载和显示关联短信的详细信息，包括发件人和内容
  - 实现短信内容的展开/折叠功能以处理长短信
  - 添加复制短信内容按钮，提升用户体验
  - 自动刷新机制，定期更新推送记录状态

## 实施计划

### 阶段一: 基础API配置功能 ✅
- 完成API配置UI界面
- 实现API配置存储和读取功能
- 添加API连接测试功能

### 阶段二: 钉钉群推送功能 ✅
- 实现钉钉Webhook配置界面
- 开发钉钉消息推送功能
- 集成到现有短信处理流程

### 阶段三: 推送扩展框架 ✅
- 设计并实现通用推送接口
- 将钉钉推送重构为扩展接口的实现
- 实现推送服务管理器

### 阶段四: 短信过滤优化 ✅
- 统一短信过滤实现方式
- 简化过滤逻辑，保持短信内容原样
- 清理冗余代码

### 阶段五: 界面布局优化 ✅
- 设计Tab布局结构
- 实现顶部导航栏
- 重组现有功能到对应标签页
- 统一UI样式和交互体验

### 阶段六: 推送记录功能 ✅
- 设计推送记录数据库结构
- 实现推送记录UI界面
- 开发记录管理相关功能
- 增强记录项显示，关联短信内容

## 技术细节

### API配置实现要点
- 移动API URL配置从 `AppConfig` 到 `ApiPushService` 中的配置管理
- 在 `PushServiceManager` 中注册和初始化 `ApiPushService`
- 实现API连接测试功能

### 钉钉推送实现要点
- 创建 `DingTalkPushService` 实现钉钉推送
- 设计钉钉消息格式和配置项
- 添加安全签名支持

### 通用推送框架实现要点
- 设计 `PushService` 接口定义基本推送方法
- 实现 `BasePushService` 基类处理通用逻辑和配置管理
- 开发 `PushServiceManager` 支持多服务注册和动态加载

### 短信过滤优化要点
- 统一使用 `SMSFilter` 进行短信过滤
- 移除内容标准化处理，保留短信原始内容
- 优化关键字匹配算法，提高匹配效率
- 删除冗余和弃用的过滤相关API

### 界面布局优化要点
- 使用 Compose Navigation 实现Tab导航
- 设计统一的服务配置卡片组件
- 实现通用的设置项组件
- 优化UI主题和样式
- 改进应用交互流程
- 添加响应式布局适配不同屏幕尺寸

### 推送记录实现要点
- 设计推送记录数据结构，包含关联的短信ID、服务类型、状态、错误信息和重试次数
- 实现推送记录 UI 组件，包括记录列表和详情卡片设计
- 开发推送记录的状态管理逻辑，处理成功、失败和待处理状态的更新
- 实现自动重试机制，处理推送失败的情况并限制最大重试次数
- 强化推送记录信息展示，关联短信内容和发件人信息
- 添加用户交互功能，包括展开/折叠详情、复制内容和手动重试
- 使用协程和异步加载确保 UI 响应性能，提供加载状态提示
- 实现自动刷新机制，定期查询数据库更新记录状态
- 添加视觉状态指示器，使用不同颜色和图标区分不同状态的记录

## 状态标记说明
- ⬜ 未完成
- ✅ 已完成 